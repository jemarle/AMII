---
title: "Proyecto: Reglas de Asociación (Aprendizaje Máquina II)"
author: "Carlos Sánchez Polo y Jesús Martínez Leal"
date: "`r Sys.Date()`"
output:
  html_document:
    echo: yes
    number_sections: no
    theme: readable
    toc: yes
subtitle: Máster Ciencia de Datos UV
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}
# Configuración general de chunks
library(knitr)
options(width = 100)
knitr::opts_chunk$set(echo = T, message = T, error = F, warning = F, comment = NA, dpi = 100, tidy = T, cache.path = '.cache/', fig.path = './figure/', include = T)
```

Como es habitual, cargamos las librerías que necesitamos al inicio del documento.

```{r librerias, message = T, include = T, echo = T}
# Carga de librerías necesarias con pacman
if (!require(pacman)) {
  install.packages("pacman")
  library(pacman)
}
pacman::p_load(readr, stringr, tidyr, dplyr, readxl, ggplot2, forcats, kableExtra, greekLetters, fitdistrplus, OneR, caret, OneR, arules, arulesCBA, arulesViz, Rgraphviz)
```

## Qualitative Bankruptcy Data Set

Utilizaremos UNA VERSIÓN PARECIDA PERO NO IGUAL del conjunto de datos `Qualitative_Bankruptcy Data Set` del repositorio *UCI Machine Learning* para trabajar el estudio de las variables Categóricas/Cualitativas y la bondad de las reglas de Asociación para extraer conocimiento de un conjunto de datos, en este caso, predecir la bancarrota (*Bankruptcy*) en base a parámetros cuantitativos/cualitativos preparados por expertos.

Cargar el fichero `Qualitative_Bankruptcy.num.txt` y crear el `data.frame` `QB`.

```{r lectura_QB}
QB <- read.table("./data/Qualitative_Bankruptcy.num.txt", header = FALSE, sep = ",", stringsAsFactors = TRUE)
```

Asigna nombres válidos a las columnas del `data.frame` (usa `make.names` para asegurarte que no contiene símbolos raros). Más información en el fichero `Qualitative_Bankruptcy.info.txt`

```{r colnames_QB}
colnames(QB) <- make.names(c("Industrial Risk", "Management Risk", 
                               "Financial Flexibility","Credibility",
                               "Competitiveness", "Operating Risk", 
                               "Bankruptcy"))
```

```{r visualizacion_QB}
str(QB)
head(QB)
```

Sabiendo que las variables numéricas representan un valor entre 0 y 10 para indicar la valoración del experto de cada variable, prueba a discretizar las variables numéricas en 3 factores ordenados **QB** de ***manera no supervisada*** para estimar la clase (`Bankruptcy`). La etiqueta asociada a valores bajos será "N" de valoración "negative", la etiqueta de valores altos será "P" de "positive" y el resto corresponderá a etiqueta "A" de "average".

```{r bin_columns}
discretizedQB <- discretize(QB, nbins = 3, method = "clusters", labels = c("N", "A", "P")) # usar discretize
head(discretizedQB)
```

Asegúrate que toda las variables son factores de 3 niveles y ORDENADOS que respetan N\<A\<P. La clase `Bankruptcy` debe tener como primera etiqueta "B".

```{r conversion_factores_ordenados}
for (i in 1:(ncol(discretizedQB) - 1)) {
  discretizedQB[[i]] <- factor(discretizedQB[[i]], levels = c("N", "A", "P"), ordered = TRUE)
}

if (levels(discretizedQB$Bankruptcy)[1] == "B"){
  print( paste( "Efectivamente, el primer nivel de la clase Bankruptcy es:", levels(discretizedQB$Bankruptcy)[1]) ) 
} else {
  print("No, el primer nivel de la clase Bankruptcy es:", levels(discretizedQB$Bankruptcy)[1])
}
```

## Análisis Cualitativo

Realiza un estudio del conjunto discretizado para determinar si es apropiado para resolver el problema (estimar Bankruptcy con el menor número de errores) .

### Análisis univariante de las variables Cualitativas

Obtén la descripción de las variables [incluida la clase]{.underline}. Al menos, se debe obtener la tabla de frecuencias y un gráfico para mostrar la frecuencias.

```{r}

```

[Describe, al menos, 2 conclusiones.]{.underline}

**\>\>\>\<\<\<Conclusiones del análisis univariante...\>\>\>\<\<\<**

### Análisis bivariante de las variables Cualitativas

Obtén la relación entre las variables [y la clase]{.underline} (ej. matrices de contingencia). Determina el grado de asociación (ej. chi2, CramerV, ...) entre cada variable y la clase.

*Nota: La función PairApply de la librería DescTools permite calcular estadísticos para todos los pares. La función PlotCorr permite representar los resultados de PairApply.*

```{r}
#solucion

```

Contrasta los resultados con los gráficos de Mosaico de los casos más relevantes.

```{r}
#solucion

```

[Describe, al menos, 2 conclusiones:]{.underline}

**\>\>\>\<\<\<Conclusiones del análisis bivariante...\>\>\>\<\<\<**

## Reglas de Asociación

Transforma el `data.frame` en *transactions* con el nombre `QBt` y analízalas con `summary`.

```{r}
#solution

```

Obtén las reglas de asociación que tienen, al menos, un `support` del 10% y una `confidence` del 100%. ¿Cuántas reglas se obtienen?

```{r}
#solution

```

Muestra las 3 primeras reglas ordenadas por `lift`.

```{r}
#solution

```

Obtén las reglas de asociación que tengan como **ANTECEDENTE** `Bankruptcy=B` . Reduce el número de reglas con las condiciones `lift>2 & count>50`. ¿Observas algún patrón/curiosidad en estas reglas?

*Nota: Representar las reglas ayuda en la interpretación.*

```{r}
#solucion

```

Obtén las reglas de asociación en las que **no** aparezca la variable`Bankruptcy` (ni en el antecedente ni en la consecuencia). Representa las reglas. ¿Para qué sirven estas reglas/grafo si no aparece la variable objetivo?

```{r}
#solucion

```

## Predicción con reglas de asociación

Desarrolla un modelo de clasificación basado en reglas de asociación para estimar la Bancarrota. Comprueba la bondad del modelo (sensibilidad y especificidad) dividiendo el conjunto de datos en Entrenamiento 80% y Test 20%. Utiliza la función `createDataPartition` y `confusionMatrix` del paquete `caret`.

```{r}
set.seed(666)
#solucion

```

[Reflexiones sobre el modelo basado en reglas:]{.underline}

**\>\>\>\<\<\<Conclusiones del modelo basado en reglas...\>\>\>\<\<\<**

¿has utilizado todas las variables en el modelo y por qué?

¿has seleccionado reglas y por qué? ¿en base a qué criterio?
